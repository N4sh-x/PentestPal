# 445 - SMB

SMB (Server Message Block) ist ein Netzwerkprotokoll, das für den Zugriff auf Dateien, Drucker und andere freigegebene Ressourcen in einem Netzwerk verwendet wird. SMB kann auf verschiedenen Betriebssystemen wie Windows und Linux (über Samba) verwendet werden. SMB arbeitet über TCP und nutzt normalerweise die Ports 139 und 445.

### Schwachstellen/Sicherheitsprobleme:

* **Veraltete SMB-Versionen (SMBv1)**: Anfällig für Angriffe wie EternalBlue.
* **Anonymer Zugriff (Null-Sessions)**: Ermöglicht unbefugten Zugriff auf freigegebene Ressourcen.
* **Schwache Konfiguration**: Falsch konfigurierte Berechtigungen erlauben unautorisierten Lese- oder Schreibzugriff.
* **Unsichere Passwörter**: Benutzerkonten mit schwachen Passwörtern können leicht durch Brute-Force-Angriffe kompromittiert werden.

#### Schritt-für-Schritt Pentesting-Anleitung:

### **Ansatz 1: SMB-Shares mit SMBClient auflisten (Null-Session)**

Überprüfe, ob der Server anonymen Zugriff auf freigegebene Ressourcen erlaubt.

```bash
smbclient -N -L //<Ziel-IP>
Sharename       Type      Comment
---------       ----      -------
print$          Disk      Printer Drivers
notes           Disk      Shared Notes
IPC$            IPC       IPC Service
SMB1 disabled -- no workgroup available
```

**Erklärung**: Wenn die Freigaben erfolgreich aufgelistet werden, ermöglicht der SMB-Server möglicherweise anonymen Zugriff, was eine Sicherheitslücke darstellt.

### **Ansatz 2: Direkter Zugriff auf SMB-Freigaben**

Versuche, auf die SMB-Freigaben zuzugreifen und Dateien herunterzuladen, falls anonymer Zugriff möglich ist.

```bash
smbclient //10.129.14.128/notes
Enter WORKGROUP\<username>'s password: 
Anonymous login successful
smb: \> ls
.                                   D        0  Wed Sep 22 18:17:51 2021
..                                  D        0  Wed Sep 22 12:03:59 2021
prep-prod.txt                       N       71  Sun Sep 19 15:45:21 2021
smb: \> get prep-prod.txt
getting file \prep-prod.txt of size 71 as prep-prod.txt (8,7 KiloBytes/sec)
```

**Erklärung**: Mit anonymem Zugang kann der Angreifer Dateien herunterladen und potenziell sensible Informationen stehlen.

### **Ansatz 3: SMB-Version und Sicherheitseinstellungen mit Nmap scannen**

Führe einen Nmap-Scan aus, um SMB-Versionen und Sicherheitsfunktionen zu prüfen.

```bash
sudo nmap -sV -sC -p139,445 <Ziel-IP>
PORT    STATE SERVICE     VERSION
139/tcp open  netbios-ssn Samba smbd 4.6.2
445/tcp open  netbios-ssn Samba smbd 4.6.2
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2021-09-19T13:16:04
```

**Erklärung**: Der Scan zeigt, dass SMBv2 verwendet wird, aber die Nachrichten-Signierung ist nicht erforderlich, was das System anfällig für Man-in-the-Middle-Angriffe machen kann.

### **Ansatz 4: Benutzer mit RPCclient enumerieren**

Nutze rpcclient, um Informationen über Benutzerkonten zu erhalten.

```bash
rpcclient -U "" <Ziel-IP>
rpcclient $> enumdomusers
user:[mrb3n] rid:[0x3e8]
user:[cry0l1t3] rid:[0x3e9]
```

**Erklärung**: Dieser Befehl listet alle Benutzer auf, die auf dem Server existieren. Dies ermöglicht Angriffe wie Brute-Force auf Passwörter.

### Sicherheitshinweise:

* Deaktiviere SMBv1 und verwende nur SMBv3, um Sicherheitslücken wie EternalBlue zu vermeiden.
* Deaktiviere anonymen Zugriff (Null-Sessions).
* Verwende starke Passwörter und implementiere strenge Passwort-Richtlinien.
* Setze die Nachrichten-Signierung durch, um Man-in-the-Middle-Angriffe zu verhindern.
