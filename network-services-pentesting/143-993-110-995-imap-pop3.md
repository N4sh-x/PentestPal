# 143, 993, 110, 995 - IMAP, POP3

## IMAP / POP3

* **IMAP (Internet Message Access Protocol)**: IMAP ist ein Protokoll, das es ermöglicht, E-Mails auf einem Server zu verwalten und darauf zuzugreifen, ohne die Nachrichten herunterzuladen. Der große Vorteil von IMAP ist, dass E-Mails auf dem Server verbleiben und von mehreren Geräten synchronisiert werden können. IMAP unterstützt Ordnerstrukturen, sodass Nachrichten direkt auf dem Server organisiert werden können. E-Mails bleiben auf dem Server, bis sie manuell gelöscht werden, was ideal für Nutzer ist, die von verschiedenen Geräten auf ihre Mails zugreifen.
* **POP3 (Post Office Protocol Version 3)**: POP3 ist ein älteres Protokoll, das darauf ausgelegt ist, E-Mails vom Server herunterzuladen und sie lokal auf dem Client zu speichern. Nach dem Herunterladen werden die Nachrichten in der Regel vom Server gelöscht (abhängig von den Einstellungen), was bedeutet, dass sie nur auf dem herunterladenden Gerät verfügbar sind. POP3 ist weniger flexibel als IMAP, da es keine Synchronisation über mehrere Geräte und keine Ordnerstrukturen auf dem Server unterstützt.

**Vergleich:**

* **IMAP**: Nachrichten bleiben auf dem Server, Zugriff von mehreren Geräten, unterstützt Ordnerstrukturen.
* **POP3**: Nachrichten werden lokal heruntergeladen und in der Regel vom Server gelöscht, weniger geeignet für den Zugriff von mehreren Geräten.

## Pentesting IMAP und POP3: Schritt-für-Schritt Anleitung

**1. Zieldefinition und Vorbereitung**

Das Ziel eines Pentests gegen IMAP und POP3 ist es, mögliche Schwachstellen in der Konfiguration von E-Mail-Servern zu finden, die Angreifern ermöglichen könnten:

* Zugriff auf E-Mail-Inhalte zu erhalten.
* Authentifizierungsmechanismen zu umgehen.
* Unsichere Verbindungen auszunutzen.

**Vorbereitung:**

* Ziel-IP oder Domain des Mail-Servers
* Genutzte Ports (standardmäßig 110, 995 für POP3 und 143, 993 für IMAP)

**2. Initialer Nmap-Scan**

Der erste Schritt eines jeden Tests ist die Identifikation offener Ports und Dienste. Hiermit können wir feststellen, ob ein Server IMAP oder POP3 (oder beides) verwendet und ob die Kommunikation verschlüsselt ist.

```bash
$ sudo nmap -sV -p110,143,993,995 {target_IP} -sC
PORT    STATE SERVICE  VERSION
110/tcp open  pop3     Dovecot pop3d
143/tcp open  imap     Dovecot imapd
993/tcp open  ssl/imap Dovecot imapd
995/tcp open  ssl/pop3 Dovecot pop3d
```

Dieser Scan liefert uns folgende Informationen:

* **Ports 110/143**: Die Dienste laufen unverschlüsselt, was die Möglichkeit eines Man-in-the-Middle (MitM)-Angriffs bietet.
* **Ports 993/995**: Die Dienste sind verschlüsselt (SSL/TLS). Wir werden in einem späteren Schritt testen, ob die Verschlüsselung sicher implementiert ist.

**3. Service-Footprinting**

Wir analysieren nun die genauen Merkmale des Mail-Servers (z. B. Version, unterstützte Features). Damit können wir potenzielle Schwachstellen des Mail-Servers identifizieren, die mit öffentlichen Exploits (CVE-Datenbanken) ausgenutzt werden könnten.

**IMAP und POP3 Fähigkeiten auflisten**

Nutze `nmap` oder `openssl`, um weitere Details zu den angebotenen Diensten zu erhalten:

```bash
$ openssl s_client -connect {target_IP}:imaps
CONNECTED(00000003)
depth=0 CN = mail1.inlanefreight.htb
verify return:1
---
Certificate chain
 0 s:C = US, ST = California, O = Inlanefreight, CN = mail1.inlanefreight.htb
...
* OK [CAPABILITY IMAP4rev1 SASL-IR LOGIN-REFERRALS] IMAP4 v1.3.1 ready
```

**Wichtige Punkte in der Ausgabe:**

* **SSL-Zertifikat**: Ist es selbstsigniert oder von einer vertrauenswürdigen CA ausgestellt?
* **SSL-Version**: Wird eine veraltete Version von SSL/TLS verwendet (z. B. TLSv1.0)?
* **Serverbanner**: Version des IMAP/POP3-Dienstes, der im Banner angezeigt wird.

**4. Bruteforce/Password Cracking**

Nach dem Sammeln von Informationen versuchen wir eine Bruteforce-Attacke gegen die Authentifizierung (falls erlaubt). Dies ist ein Versuch, durch das Testen verschiedener Passwortkombinationen Zugang zu erhalten.

**Bruteforce mit Hydra:**

```bash
$ hydra -l {username} -P {password_list} {target_IP} imap
```

Für POP3 verwenden wir:

```bash
$ hydra -l {username} -P {password_list} {target_IP} pop3
```

**Beispiel:**

```bash
$ hydra -l user -P /usr/share/wordlists/rockyou.txt 10.129.14.128 imap
```

**Hinweis**: Bruteforce-Angriffe sollten nur mit ausdrücklicher Erlaubnis durchgeführt werden und sind oft durch Ratenbegrenzungen geschützt.

**5. Direkte Interaktion mit IMAP/POP3**

Mit einem direkten Zugriff auf den Dienst können wir manuell Befehle senden, um Informationen zu extrahieren oder Nachrichten zu manipulieren.

**IMAP-Interaktion über Telnet:**

```bash
$ telnet {target_IP} 143
```

**Beispiele für IMAP-Befehle:**

```bash
1 LOGIN username password       # Login
1 LIST "" *                     # Listet alle Verzeichnisse auf
1 SELECT INBOX                  # Wählt das INBOX-Postfach aus
1 FETCH {ID} all                # Ruft Daten einer Nachricht ab
1 LOGOUT                        # Beendet die Sitzung
```

**POP3-Interaktion über Telnet:**

```bash
$ telnet {target_IP} 110
```

**Beispiele für POP3-Befehle:**

```bash
USER username                   # Benutzername
PASS password                   # Passwort
STAT                            # Anzahl der Nachrichten und ihre Gesamtgröße
LIST                            # Nachrichtengrößen auflisten
RETR {ID}                       # Nachricht herunterladen
QUIT                            # Verbindung beenden
```

**6. Prüfen der Verschlüsselung (SSL/TLS)**

IMAP und POP3 sollten idealerweise über SSL/TLS gesichert sein. Veraltete oder unsichere Verschlüsselungen wie SSLv2/v3 oder TLSv1.0 sind anfällig für Angriffe (z. B. POODLE, DROWN).

**SSL-Überprüfung mit SSL Labs oder Nmap:**

```bash
$ nmap --script ssl-enum-ciphers -p993,995 {target_IP}
```

Diese Nmap-Skripte listen die unterstützten SSL/TLS-Versionen und Ciphers auf, die auf dem Zielsystem aktiviert sind. So können wir feststellen, ob unsichere Protokolle verwendet werden.

**7. Angriffsszenarien bei Fehlkonfiguration**

Schwachstellen in der Konfiguration der Authentifizierung oder des SSL/TLS-Protokolls können Angreifern den Zugang ermöglichen. Zu den häufigen Fehlern zählen:

* **Unverschlüsselte Übertragungen** (keine SSL/TLS-Verschlüsselung).
* **Debug-Modus aktiviert**: Protokolliert Anmeldedaten (z. B. Passwörter im Klartext).
* **Anonyme Logins**: Zugriff ohne Authentifizierung möglich.

**8. Post-Exploitation: Lesen und Manipulieren von E-Mails**

Wenn es gelingt, Zugang zum Mail-Server zu erlangen, können folgende Aktionen durchgeführt werden:

* **Lesen von E-Mails**: Kritische oder sensible Informationen extrahieren.
* **Manipulieren von E-Mails**: Eine neue E-Mail versenden, als wäre sie von einem legitimen Benutzer.

Beispiel zum Abrufen einer Nachricht:

```bash
$ telnet {target_IP} 143
1 LOGIN victim password
1 SELECT INBOX
1 FETCH {message_ID} all
```

**9. Verteidigungsempfehlungen**

Nach der Identifikation von Schwachstellen sollten Unternehmen Maßnahmen ergreifen, um ihre IMAP/POP3-Dienste zu sichern:

* **SSL/TLS verpflichtend aktivieren**: Nutze moderne Verschlüsselungsprotokolle wie TLSv1.2 oder höher.
* **Rate Limiting für Anmeldungen**: Schutz vor Bruteforce-Angriffen durch Anmeldebeschränkungen.
* **Logfiles überwachen**: Ungewöhnliche Aktivitäten (z. B. wiederholte Anmeldeversuche) frühzeitig erkennen.
* **Schwachstellen regelmäßig patchen**: Verwende aktuelle Versionen von IMAP/POP3-Diensten.

Mit diesen Schritten lässt sich eine umfassende Überprüfung der Sicherheit von IMAP/POP3-Servern durchführen und Schwachstellen effizient aufdecken.
