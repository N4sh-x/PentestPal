# 25 - SMTP

SMTP steht für "Simple Mail Transfer Protocol" und wird verwendet, um den Versand von E-Mails zu verwalten. Es arbeitet in Verbindung mit POP oder IMAP, um sowohl den Versand als auch den Empfang von E-Mails zu ermöglichen.

#### **SMTP Functions:**

1. **Verifizierung:** Der SMTP-Server überprüft, wer E-Mails über ihn sendet
2. **Versand:** Er versendet die ausgehende E-Mail
3. **Fehlermeldung:** Wenn die E-Mail nicht zugestellt werden kann, wird eine Nachricht an den Absender zurückgesendet

#### **POP vs. IMAP:**

* **POP (Post Office Protocol):** Lädt die gesamte Mailbox vom Server herunter und speichert sie lokal.
* **IMAP (Internet Message Access Protocol):** Synchronisiert die Mailbox zwischen dem Server und dem Client, sodass Änderungen an der Mailbox auf allen Geräten sichtbar sind.

## Ablauf SMTP

#### **1. SMTP Handshake**

* **Verbindung:** Dein E-Mail-Client (Mail User Agent) verbindet sich mit dem SMTP-Server deines E-Mail-Anbieters, z.B. `smtp.google.com`, über den SMTP-Port (normalerweise 25).
* **Handshake:** Der SMTP-Server und dein Client führen einen Handshake durch, bei dem die Verbindung und die Identität des Absenders validiert werden.
* **Sitzung:** Nach erfolgreichem Handshake beginnt die SMTP-Sitzung, in der E-Mails gesendet werden können.

#### **2. Senden der E-Mail**

* **Übermittlung:** Dein E-Mail-Client übermittelt dem SMTP-Server den Absender (MAIL FROM), den Empfänger (RCPT TO), den Inhalt der E-Mail und eventuelle Anhänge.
* **Validierung:** Der SMTP-Server prüft, ob die E-Mail korrekt formatiert ist und ob alle erforderlichen Informationen vorhanden sind.

#### **3. Prüfung der Domain**

* **Interne Zustellung:** Der SMTP-Server prüft, ob die Domain des Empfängers mit der des Absenders übereinstimmt.
  * **Gleiche Domain:** Wenn die Domains übereinstimmen (z.B. beide E-Mail-Adressen gehören zu `example.com`), wird die E-Mail direkt intern zugestellt.
  * **Unterschiedliche Domains:** Wenn die Domains unterschiedlich sind, wird die E-Mail an den SMTP-Server des Empfängers weitergeleitet.

#### **4. Weiterleitung und SMTP Queue**

* **Verbindung zum Empfänger-Server:** Der SMTP-Server des Absenders stellt eine Verbindung zum SMTP-Server des Empfängers her.
* **Fehlerbehandlung:** Wenn der Empfänger-Server nicht erreichbar ist oder es andere Probleme gibt, wird die E-Mail in eine **SMTP Queue** gestellt.
  * **SMTP Queue:** Dies ist ein temporärer Speicher auf dem Server, in dem die E-Mail verbleibt, bis der SMTP-Server des Empfängers erreichbar ist. Der SMTP-Server versucht regelmäßig, die E-Mail erneut zuzustellen.

#### **5. Zustellung der E-Mail**

* **Verifikation durch den Empfänger-Server:** Der SMTP-Server des Empfängers prüft, ob die Domain und der Benutzername existieren und gültig sind.
* **Weiterleitung an POP/IMAP:** Wenn die E-Mail verifiziert ist, leitet der SMTP-Server sie an den entsprechenden POP- oder IMAP-Server weiter.
* **E-Mail im Posteingang:** Die E-Mail erscheint schließlich im Posteingang des Empfängers.

## SMTP Enumeration: Zusammenfassung

#### **1. Enumerating Server Details**

Bevor du einen Angriff auf einen SMTP-Server startest, ist es wichtig, den Server zu fingerprinten, um gezielte Angriffe zu ermöglichen. Eine schwach konfigurierte oder verwundbare E-Mail-Server kann oft einen ersten Einstieg in ein Netzwerk bieten.

* **Tool:** MetaSploit `smtp_version` Modul.
* **Ziel:** Scannt eine Reihe von IP-Adressen und bestimmt die Version der dort laufenden SMTP-Server.
* **Vorgehen:** Die Ermittlung der Version ermöglicht es, gezielte Schwachstellen auszunutzen.

#### **2. Enumerating Users from SMTP**

Der SMTP-Dienst bietet interne Befehle zur Benutzerenumeration, die genutzt werden können, um gültige Benutzerkonten zu identifizieren:

* **VRFY:** Bestätigt die Existenz eines Benutzernamens.
* **EXPN:** Gibt die tatsächliche Adresse von Benutzeraliasen und Mailinglisten preis.

Diese Befehle können manuell über eine Telnet-Verbindung verwendet werden, aber MetaSploit bietet ein spezielles Modul namens `smtp_enum`, das den Prozess automatisiert.

* **Tool:** MetaSploit `smtp_enum` Modul.
* **Ziel:** Scannt einen Host oder eine Reihe von Hosts und verwendet eine Wordlist, um Benutzernamen zu ermitteln.

#### **3. Anforderungen**

* **Metasploit:** Stelle sicher, dass Metasploit auf deinem System installiert und auf dem neuesten Stand ist. Dies ist standardmäßig auf Kali Linux und Parrot OS vorhanden.
* **Update:** Führe `sudo apt update` und ggf. ein Upgrade durch, um sicherzustellen, dass du die neueste Version hast.

#### **4. Alternativen**

Es gibt alternative Tools wie `smtp-user-enum`, die für die Enumeration von OS-Level-Benutzerkonten über den SMTP-Dienst noch effektiver sein können, insbesondere auf Solaris-Systemen. Diese Tools arbeiten, indem sie die Antworten auf die VRFY-, EXPN- und RCPT TO-Befehle auswerten.

* **Tool:** `smtp-user-enum`
* **Anwendung:** Besonders nützlich bei der Enumeration von Benutzern auf Solaris-Systemen.

#### **Zusammenfassung**

Durch die Kombination von Server-Fingerprinting und Benutzerenumeration kannst du Schwachstellen im SMTP-Dienst ausnutzen, um Informationen zu sammeln und gezielte Angriffe durchzuführen. Die Verwendung von Metasploit erleichtert diesen Prozess erheblich, aber es ist auch sinnvoll, alternative Tools in Betracht zu ziehen, um deine Methodik zu erweitern.

## Step by Step

| telnet \<IP-Adresse> 25                           | Sammle Informationen über den SMTP-Server, wie z.B. die Serverversion und unterstützte Befehle.        |
| ------------------------------------------------- | ------------------------------------------------------------------------------------------------------ |
| nmap --script smtp-enum-users -p 25 \<IP-Adresse> | Führt eine Benutzerenumeration durch, um gültige Benutzerkonten auf dem SMTP-Server zu identifizieren. |
| msfconsole                                        | öffne Metasploit                                                                                       |
| msfconsole                                        |                                                                                                        |
| use auxiliary/scanner/smtp/smtp\_version          |                                                                                                        |
| set RHOSTS \<IP-Adresse>                          |                                                                                                        |
| run                                               | Ermittelt die Version des SMTP-Servers                                                                 |
| use auxiliary/scanner/smtp/smtp\_enum             |                                                                                                        |
| set RHOSTS \<IP-Adresse>                          |                                                                                                        |
| set USER\_FILE \<Pfad\_zur\_Wordlist>             |                                                                                                        |
| run                                               | Listet gültige Benutzernamen auf dem SMTP-Server auf                                                   |
